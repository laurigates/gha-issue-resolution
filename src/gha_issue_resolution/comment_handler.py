from pathlib import Path
from gha_issue_resolution.ai_utils import query_gemini, generate_detailed_prompt
from gha_issue_resolution.file_utils import get_repo_structure, get_file_content

TRIGGER_PR_COMMENT = "/create-pr"
TRIGGER_UPDATE_COMMENT = "/update"

def get_relevant_files(repo_structure):
    """Get files that are likely relevant to code changes"""
    relevant_extensions = {'.py', '.js', '.ts', '.jsx', '.tsx', '.html', '.css', '.yml', '.yaml', '.json', '.md', '.txt'}
    files = []
    
    for line in repo_structure.split('\n'):
        if line.strip():
            file_path = line.strip('- ').strip()
            if any(file_path.endswith(ext) for ext in relevant_extensions):
                files.append(file_path)
    
    return files

def create_analysis_comment(issue):
    """Generate and post initial analysis comment"""
    print("\nGenerating initial analysis...")
    
    # Get repository structure and initial files content
    repo_structure = get_repo_structure()
    print("\nGetting repository files...")
    
    # Get all potentially relevant files
    relevant_files = get_relevant_files(repo_structure)
    file_contents = ""
    
    # Add content of all files
    for file_path in relevant_files:
        if Path(file_path).is_file():
            content = get_file_content(file_path)
            file_contents += f"\nContent of {file_path}:\n```\n{content}\n```\n"
            print(f"Added content of {file_path}")

    initial_prompt = f"""
    Analyze this GitHub issue and suggest a solution based on the repository content:
    
    Issue Title: {issue.title}
    Issue Body: {issue.body}
    
    Repository Structure:
    {repo_structure}
    
    Relevant Files Content:
    {file_contents}
    
    Please provide:
    1. A detailed analysis of the issue and what needs to be changed
    2. List the specific files that need modification and explain why
    3. For each file that needs changes, provide:
       a. The current state and why it needs to change
       b. The specific changes required
       c. Complete code for the changes using this format:
       
       File: path/to/file.py (CURRENT CONTENT)
       ```python
       # Current content here
       ```
       
       Changes to make:
       - Detailed description of change 1
       - Detailed description of change 2
       
       File: path/to/file.py (WITH CHANGES)
       ```python
       # Complete new content with changes
       ```
    
    4. Explain how these changes will resolve the issue
    5. Note any potential side effects or additional considerations
    """
    
    initial_response = query_gemini(initial_prompt)
    
    # Extract file paths from the initial response for more detailed analysis
    identified_files = [
        line.split()[-1] 
        for line in initial_response.split('\n') 
        if line.startswith('-') and '.' in line
    ]
    
    # Use all identified files for detailed solution
    if identified_files:
        print(f"\nIdentified specific files for detailed analysis: {identified_files}")
        detailed_prompt = generate_detailed_prompt(issue, initial_response, identified_files)
        print("\nGenerating detailed solution...")
        detailed_solution = query_gemini(detailed_prompt)
    else:
        detailed_solution = initial_response
    
    comment_body = f"""
    ## AI-generated suggestion

    Here's a potential solution to this issue, generated by an AI assistant:

    {detailed_solution}

    To create a pull request with these changes, comment with: `{TRIGGER_PR_COMMENT}`
    To get an updated analysis, comment with: `{TRIGGER_UPDATE_COMMENT}`
    
    This is an AI-generated response and requires human validation and testing before implementation.
    """
    
    comment = issue.create_comment(comment_body)
    print(f"\nAdded initial analysis comment: {comment.html_url}")
    return comment

def create_response_comment(issue, trigger_comment):
    """Generate and post a response to a human comment"""
    print("\nGenerating response to comment...")
    
    # Get the conversation history
    comments = list(issue.get_comments())
    conversation = []
    for comment in comments:
        if comment.user.login == issue.user.login:
            conversation.append(f"User: {comment.body}")
        elif "AI-generated" in comment.body:
            conversation.append(f"Assistant: {comment.body}")
    
    # Get repository structure for context
    repo_structure = get_repo_structure()
    # Get relevant file contents for context
    relevant_files = get_relevant_files(repo_structure)
    file_contents = ""
    for file_path in relevant_files:
        if Path(file_path).is_file():
            content = get_file_content(file_path)
            file_contents += f"\nContent of {file_path}:\n```\n{content}\n```\n"
    
    response_prompt = f"""
    Please provide a response to this comment in the context of the GitHub issue:
    
    Issue Title: {issue.title}
    Issue Body: {issue.body}
    
    Repository Structure:
    {repo_structure}
    
    Relevant Files:
    {file_contents}
    
    Previous conversation:
    {'\n'.join(conversation)}
    
    Latest comment to respond to:
    {trigger_comment.body}
    
    Please provide:
    1. A direct response to the comment
    2. If code changes are needed, follow the same format as before:
       
       File: path/to/file.py (CURRENT CONTENT)
       ```python
       # Current content
       ```
       
       Changes to make:
       - Description of changes
       
       File: path/to/file.py (WITH CHANGES)
       ```python
       # New content
       ```
    """
    
    response = query_gemini(response_prompt)
    
    comment_body = f"""
    ## AI-generated response

    {response}

    To create a pull request with any code changes suggested above, comment with: `{TRIGGER_PR_COMMENT}`
    To get an updated analysis, comment with: `{TRIGGER_UPDATE_COMMENT}`
    """
    
    comment = issue.create_comment(comment_body)
    print(f"\nAdded response comment: {comment.html_url}")
    return comment

def get_bot_comments(issue):
    """Get all AI-generated comments on the issue"""
    bot_comments = []
    for comment in issue.get_comments():
        if "AI-generated suggestion" in comment.body or "AI-generated response" in comment.body:
            bot_comments.append(comment)
    return bot_comments

def get_human_feedback(issue, last_bot_comment):
    """Get human feedback comments after the last bot comment"""
    all_comments = list(issue.get_comments())
    last_bot_index = all_comments.index(last_bot_comment)
    human_feedback = []
    for comment in all_comments[last_bot_index + 1:]:
        if "AI-generated" not in comment.body:
            human_feedback.append(comment.body)
    return human_feedback

def check_triggers(comment):
    """Check if a comment contains trigger commands"""
    if not comment or not hasattr(comment, 'body'):
        return False, False
    
    body = comment.body.lower()
    return TRIGGER_PR_COMMENT.lower() in body, TRIGGER_UPDATE_COMMENT.lower() in body